<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.kh.project.board.model.mapper.CommentMapper">

    <!-- 댓글 조회 결과 매핑 -->
    <resultMap id="comment_rm" type="Comment">
        <id property="commentNo" column="COMMENT_NO"/>
        <result property="commentContent" column="COMMENT_CONTENT"/>
        <result property="commentWriteDate" column="COMMENT_WRITE_DATE"/>
        <result property="commentDelFl" column="COMMENT_DEL_FL"/>
        <result property="boardNo" column="BOARD_NO"/>
        <result property="memberNo" column="MEMBER_NO"/>
        <result property="parentCommentNo" column="PARENT_COMMENT_NO"/>
        <result property="profileImg" column="PROFILE_IMG"/>
        <result property="memberNickname" column="MEMBER_NICKNAME"/>
    </resultMap>

    <!-- 댓글 목록 조회 -->
    <select id="selectCommentList" resultMap="comment_rm">
        SELECT 
            C.COMMENT_NO,
            C.COMMENT_CONTENT,
            TO_CHAR(C.COMMENT_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS COMMENT_WRITE_DATE,
            C.COMMENT_DEL_FL,
            C.BOARD_NO,
            C.MEMBER_NO,
            NVL(C.PARENT_COMMENT_NO, 0) AS PARENT_COMMENT_NO,
            M.PROFILE_IMG,
            M.MEMBER_NICKNAME
        FROM "COMMENT" C
        JOIN "MEMBER" M ON C.MEMBER_NO = M.MEMBER_NO
        WHERE C.BOARD_NO = #{boardNo}
        ORDER BY 
            NVL(C.PARENT_COMMENT_NO, C.COMMENT_NO),
            C.COMMENT_NO
    </select>

    <!-- 댓글 등록 -->
    <insert id="insertComment">
        INSERT INTO "COMMENT" (
            COMMENT_NO,
            COMMENT_CONTENT,
            BOARD_NO,
            MEMBER_NO,
            PARENT_COMMENT_NO
        ) VALUES (
            SEQ_COMMENT_NO.NEXTVAL,
            #{commentContent},
            #{boardNo},
            #{memberNo},
            NULLIF(#{parentCommentNo}, 0)
        )
    </insert>

    <!-- 댓글 수정 -->
    <update id="updateComment">
        UPDATE "COMMENT"
        SET COMMENT_CONTENT = #{commentContent}
        WHERE COMMENT_NO = #{commentNo}
    </update>

    <!-- 댓글 삭제 (논리적 삭제) -->
    <update id="deleteComment">
        UPDATE "COMMENT"
        SET COMMENT_DEL_FL = 'Y'
        WHERE COMMENT_NO = #{commentNo}
    </update>


	<!-- 고객지원 게시판 댓글 권한용: 글 작성자 조회 -->
	<select id="selectBoardWriter" resultType="int">
    SELECT MEMBER_NO
    FROM BOARD
    WHERE BOARD_NO = #{boardNo}
     AND BOARD_CODE = #{boardCode}
	</select>
	
	<!-- ============================================
	           댓글 신고 관련 SQL
	     ============================================ -->

	<!-- 댓글 신고 중복 체크 -->
	<select id="checkCommentReport" resultType="int">
		SELECT COUNT(*)
		FROM COMMENT_REPORT
		WHERE COMMENT_NO = #{commentNo}
		  AND MEMBER_NO = #{memberNo}
	</select>

	<!-- 댓글 신고 등록 -->
	<insert id="insertCommentReport">
		INSERT INTO COMMENT_REPORT (
			REPORT_NO,
			REPORT_REASON,
			MEMBER_NO,
			COMMENT_NO
		) VALUES (
			SEQ_COMMENT_REPORT_NO.NEXTVAL,
			#{reportReason},
			#{memberNo},
			#{commentNo}
		)
	</insert>
		
	<!-- ============================================
	           댓글 좋아요 관련 
	   ============================================ -->

	<!-- 댓글 좋아요 체크 -->
	<select id="checkCommentLike" resultType="int">
		SELECT COUNT(*)
		FROM COMMENT_LIKE
		WHERE COMMENT_NO = #{commentNo}
		  AND MEMBER_NO = #{memberNo}
	</select>

	<!-- 댓글 좋아요 등록 -->
	<insert id="insertCommentLike">
		INSERT INTO COMMENT_LIKE (COMMENT_NO, MEMBER_NO)
		VALUES (#{commentNo}, #{memberNo})
	</insert>

	<!-- 댓글 좋아요 삭제 -->
	<delete id="deleteCommentLike">
		DELETE FROM COMMENT_LIKE
		WHERE COMMENT_NO = #{commentNo}
		  AND MEMBER_NO = #{memberNo}
	</delete>

	<!-- 댓글 좋아요 수 조회 -->
	<select id="countCommentLike" resultType="int">
		SELECT COUNT(*)
		FROM COMMENT_LIKE
		WHERE COMMENT_NO = #{commentNo}
	</select>

</mapper>