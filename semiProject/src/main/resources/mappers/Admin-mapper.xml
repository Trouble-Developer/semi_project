<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.kh.project.admin.model.mapper.AdminMapper">

  <!-- 회원 수 조회 - 회원이 총 몇 명인지 알아야 페이지 수를 계산 가능 -->
  <select id="getMemberCount" resultType="int">
    SELECT COUNT(*)
    FROM MEMBER
    <where>
      <if test="key != null and query != null">
        <choose>
          <when test="'memberNo'.equals(key)">
            MEMBER_NO = #{query}
          </when>
          <when test="'email'.equals(key)">
            MEMBER_EMAIL LIKE '%' || #{query} || '%'
          </when>
          <when test="'nickname'.equals(key)">
            MEMBER_NICKNAME LIKE '%' || #{query} || '%'
          </when>
        </choose>
      </if>
    </where>
  </select>

  <!-- 회원 목록 조회 -->
  <select id="selectMemberList"
          resultType="edu.kh.project.admin.dto.AdminMember">
    SELECT
      MEMBER_NO AS memberNo,
      MEMBER_EMAIL AS memberEmail,
      MEMBER_NICKNAME AS memberNickname,
      MEMBER_DEL_FL AS memberDelFl,
      ENROLL_DATE AS enrollDate
    FROM MEMBER
    <where>
      <if test="key != null and query != null">
        <choose>
          <when test="'memberNo'.equals(key)">
            MEMBER_NO = #{query}
          </when>
          <when test="'email'.equals(key)">
            MEMBER_EMAIL LIKE '%' || #{query} || '%'
          </when>
          <when test="'nickname'.equals(key)">
            MEMBER_NICKNAME LIKE '%' || #{query} || '%'
          </when>
        </choose>
      </if>
    </where>
    ORDER BY MEMBER_NO DESC
    OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
  </select>

  <!-- 회원 상태 변경 (탈퇴 / 복구 공통) -->
  <update id="updateMemberStatus"
          parameterType="map">
    UPDATE MEMBER
    SET MEMBER_DEL_FL = #{memberDelFl}
    WHERE MEMBER_NO = #{memberNo}
  </update>
  
  
  <!-- 공지사항 -->
  <!-- 공지사항 전체 개수 조회 (검색 조건 포함) -->
  <select id="getNoticeCount"
          parameterType="map"
          resultType="int">

    SELECT COUNT(*)
    FROM BOARD B
    WHERE B.BOARD_DEL_FL IN ('Y','N')
      AND B.BOARD_CODE = 4

    <choose>
      <when test='key == "t"'>
        AND B.BOARD_TITLE LIKE '%' || #{query} || '%'
      </when>

      <when test='key == "c"'>
        AND B.BOARD_CONTENT LIKE '%' || #{query} || '%'
      </when>

      <when test='key == "tc"'>
        AND (
          B.BOARD_TITLE LIKE '%' || #{query} || '%'
          OR B.BOARD_CONTENT LIKE '%' || #{query} || '%'
        )
      </when>
    </choose>
  
  </select>
  
  <!-- 공지사항 목록 조회 -->
  <select id="selectNoticeList"
          parameterType="map"
          resultType="edu.kh.project.admin.dto.AdminNotice">

    SELECT
      B.BOARD_NO         AS boardNo,
      B.BOARD_TITLE      AS boardTitle,
      M.MEMBER_NICKNAME  AS memberNickname,
      B.READ_COUNT       AS readCount,
      TO_CHAR(B.BOARD_WRITE_DATE, 'YYYY-MM-DD') AS boardWriteDate,
      B.BOARD_DEL_FL     AS boardDelFl 

    FROM BOARD B
    JOIN MEMBER M
      ON B.MEMBER_NO = M.MEMBER_NO

    WHERE B.BOARD_DEL_FL IN ('Y','N')
      AND B.BOARD_CODE = 4   <!-- 관리자 공지사항 고정 -->

    <choose>
      <!-- 제목 검색 -->
      <when test='key == "t"'>
        AND B.BOARD_TITLE LIKE '%' || #{query} || '%'
      </when>

      <!-- 내용 검색 -->
      <when test='key == "c"'>
        AND B.BOARD_CONTENT LIKE '%' || #{query} || '%'
      </when>

      <!-- 제목 + 내용 -->
      <when test='key == "tc"'>
        AND (
          B.BOARD_TITLE LIKE '%' || #{query} || '%'
          OR B.BOARD_CONTENT LIKE '%' || #{query} || '%'
        )
      </when>
    </choose>

    ORDER BY B.BOARD_NO DESC
    OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY

  </select>

  <!-- 공지사항 삭제/복구 (관리자 전용 / 논리 삭제) -->
  <update id="updateNoticeStatus" parameterType="map">
  UPDATE BOARD
  SET BOARD_DEL_FL = #{boardDelFl}
  WHERE BOARD_NO = #{boardNo}
  </update>



  <!-- 고객지원 게시글 -->
  <!-- 고객지원 게시글 전체 개수 조회 -->
  <!-- 페이징 계산을 위해 먼저 COUNT -->
  <select id="getSupportCount" parameterType="map" resultType="int">
	SELECT COUNT(*)
	FROM BOARD B
	WHERE B.BOARD_CODE = 5 <!-- 고객지원 게시판 코드 -->
	AND B.BOARD_DEL_FL IN ('Y', 'N')
	
	<!-- 검색 조건 -->
	<if test="key != null and query != null and query != ''">
	  <choose>
	    <when test="key == 'title'">
	      AND B.BOARD_TITLE LIKE '%' || #{query} || '%'
	    </when>
	    <when test="key == 'content'">
	      AND B.BOARD_CONTENT LIKE '%' || #{query} || '%'
	    </when>
	    <when test="key == 'writer'">
	      AND EXISTS ( <!-- 서브쿼리 결과가 1건이라도 존재하면 TRUE -->
          	SELECT *
          	FROM MEMBER M
          	WHERE M.MEMBER_NO = B.MEMBER_NO
            AND M.MEMBER_NICKNAME LIKE '%' || #{query} || '%'
          )
	    </when>
	  </choose>
	</if>
  </select>
  
  
  <!-- 고객지원 게시글 목록 조회 -->
  <select id="selectSupportList"
        parameterType="map"
        resultType="edu.kh.project.admin.dto.AdminSupport">
	SELECT
    	B.BOARD_NO        AS boardNo,
    	B.BOARD_TITLE     AS boardTitle,
    	M.MEMBER_NICKNAME AS memberNickname,
    	TO_CHAR(B.BOARD_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS boardWriteDate,
    	B.BOARD_DEL_FL    AS boardDelFl
  	FROM BOARD B
  	JOIN MEMBER M ON B.MEMBER_NO = M.MEMBER_NO
  	WHERE B.BOARD_CODE = 5
    AND B.BOARD_DEL_FL IN ('Y','N')

    <!-- 검색 조건 -->
    <if test="key != null and query != null and query != ''">
      <choose>
        <when test="key == 'title'">
          AND B.BOARD_TITLE LIKE '%' || #{query} || '%'
        </when>
        <when test="key == 'content'">
          AND B.BOARD_CONTENT LIKE '%' || #{query} || '%'
        </when>
        <when test="key == 'writer'">
          AND M.MEMBER_NICKNAME LIKE '%' || #{query} || '%'
        </when>
      </choose>
    </if>

    <!-- 최신 글이 위로 오도록 정렬 -->
    ORDER BY B.BOARD_NO DESC
  
    <!-- 페이징 처리 -->
    OFFSET #{offset} ROWS
    FETCH NEXT #{limit} ROWS ONLY
  </select>
  
  
  <!-- 고객지원 게시글 삭제 / 복구 -->
  <update id="updateSupportStatus" parameterType="map">
	UPDATE BOARD
	SET BOARD_DEL_FL = #{boardDelFl}
	WHERE BOARD_NO = #{boardNo}
  </update>



<!-- =========================================================
     신고글 전체 개수 조회 (검색 포함) - 수정본
     ========================================================= -->
	<select id="getReportCount"
        parameterType="map"
        resultType="int">

		SELECT COUNT(*)
		FROM (
		    /* 게시글 신고 */
		    SELECT
		    	'BOARD'           AS reportType,
		        B.BOARD_TITLE     AS targetTitle,
		        B.BOARD_CONTENT   AS boardContent,
		        M.MEMBER_NICKNAME AS reporterNickname
		    FROM BOARD_REPORT BR
		    JOIN BOARD B ON BR.BOARD_NO = B.BOARD_NO
		    JOIN MEMBER M ON BR.MEMBER_NO = M.MEMBER_NO
		    WHERE BR.PROCESS_YN = 'N'
		
		    UNION ALL
		
		    /* 댓글 신고 */
		    SELECT
		    	'COMMENT'         AS reportType,
		        B.BOARD_TITLE     AS targetTitle,
		        B.BOARD_CONTENT   AS boardContent,
		        M.MEMBER_NICKNAME AS reporterNickname
		    FROM COMMENT_REPORT CR
		    JOIN "COMMENT" C ON CR.COMMENT_NO = C.COMMENT_NO
		    JOIN BOARD B ON C.BOARD_NO = B.BOARD_NO
		    JOIN MEMBER M ON CR.MEMBER_NO = M.MEMBER_NO
		    WHERE CR.PROCESS_YN = 'N'
		) R
		<where>
			<!-- 옵션(전체, 게시글, 댓글) -->
			<if test="reportType != null and reportType != 'all'">
            	R.reportType = #{reportType}
        	</if>
        	
        	<!-- 검색 조건 -->
		    <if test="key != null and query != null">
		        <choose>
		            <when test="key == 'title'">
		                R.targetTitle LIKE '%' || #{query} || '%'
		            </when>
		            <when test="key == 'content'">
		                R.boardContent LIKE '%' || #{query} || '%'
		            </when>
		            <when test="key == 'writer'">
		                R.reporterNickname LIKE '%' || #{query} || '%'
		            </when>
		        </choose>
		    </if>
		</where>
		
		</select>


<!-- =========================================================
     신고글 목록 조회 (검색 + 페이지네이션)
     ========================================================= -->
	<select id="selectReportList"
        parameterType="map"
        resultType="edu.kh.project.admin.dto.Report">

	SELECT
	    reportNo,
	    reportType,
	    reportReason,
	    reportDate,
	    reportStatus,
	    boardNo,
	    targetTitle,
	    reporterNickname
	FROM (
	    SELECT
	        ROW_NUMBER() OVER (ORDER BY reportDate DESC) AS RN,
	        R.*
	    FROM (
	
	        <!-- ================= 게시글 신고 ================= -->
	        <if test="reportType == 'all' or reportType == 'BOARD'">
	        SELECT
	            BR.REPORT_NO         AS reportNo,
	            'BOARD'              AS reportType,
	            BR.REPORT_REASON     AS reportReason,
	            BR.REPORT_DATE       AS reportDate,
	            BR.PROCESS_YN        AS reportStatus,
	            B.BOARD_NO           AS boardNo,
	            B.BOARD_TITLE        AS targetTitle,
	            B.BOARD_CONTENT      AS boardContent,
	            M.MEMBER_NICKNAME    AS reporterNickname
	        FROM BOARD_REPORT BR
	        JOIN BOARD B ON BR.BOARD_NO = B.BOARD_NO
	        JOIN MEMBER M ON BR.MEMBER_NO = M.MEMBER_NO
	        WHERE BR.PROCESS_YN = 'N'
	        </if>
	
	        <!-- UNION ALL 은 전체일 때만 -->
	        <if test="reportType == 'all'">
	        UNION ALL
	        </if>
	
	        <!-- ================= 댓글 신고 ================= -->
	        <if test="reportType == 'all' or reportType == 'COMMENT'">
	        SELECT
	            CR.REPORT_NO         AS reportNo,
	            'COMMENT'            AS reportType,
	            CR.REPORT_REASON     AS reportReason,
	            CR.REPORT_DATE       AS reportDate,
	            CR.PROCESS_YN        AS reportStatus,
	            B.BOARD_NO           AS boardNo,
	            B.BOARD_TITLE        AS targetTitle,
	            B.BOARD_CONTENT      AS boardContent,
	            M.MEMBER_NICKNAME    AS reporterNickname
	        FROM COMMENT_REPORT CR
	        JOIN "COMMENT" C ON CR.COMMENT_NO = C.COMMENT_NO
	        JOIN BOARD B ON C.BOARD_NO = B.BOARD_NO
	        JOIN MEMBER M ON CR.MEMBER_NO = M.MEMBER_NO
	        WHERE CR.PROCESS_YN = 'N'
	        </if>
	
	    ) R
	
	    <!-- ================= 검색 조건 ================= -->
	    <where>
	        <if test="key != null and query != null">
	            <choose>
	                <when test="key == 'title'">
	                    R.targetTitle LIKE '%' || #{query} || '%'
	                </when>
	                <when test="key == 'content'">
	                    R.boardContent LIKE '%' || #{query} || '%'
	                </when>
	                <when test="key == 'writer'">
	                    R.reporterNickname LIKE '%' || #{query} || '%'
	                </when>
	            </choose>
	        </if>
	    </where>
	
	)
	WHERE RN BETWEEN #{offset} + 1 AND #{offset} + #{limit}
	
	</select>

  <!-- 게시글 신고 기각 -->
<update id="rejectBoardReport" parameterType="int">
  UPDATE BOARD_REPORT
  SET PROCESS_YN = 'Y'
  WHERE REPORT_NO = #{reportNo}
</update>

<!-- 댓글 신고 기각 -->
<update id="rejectCommentReport" parameterType="int">
  UPDATE COMMENT_REPORT
  SET PROCESS_YN = 'Y'
  WHERE REPORT_NO = #{reportNo}
</update>

  <!-- 신고된 게시글 삭제 -->
  <update id="deleteReportedBoard" parameterType="map">
    UPDATE BOARD
    SET BOARD_DEL_FL = 'Y'
    WHERE BOARD_NO = #{targetNo}
  </update>

  <!-- 게시글 신고 처리 완료 -->
  <update id="updateBoardReportProcess" parameterType="map">
    UPDATE BOARD_REPORT
    SET PROCESS_YN = 'Y'
    WHERE REPORT_NO = #{reportNo}
  </update>

  <!-- 신고된 댓글 삭제 -->
  <update id="deleteReportedComment" parameterType="map">
    UPDATE "COMMENT"
    SET COMMENT_DEL_FL = 'Y'
    WHERE COMMENT_NO = #{targetNo}
  </update>

  <!-- 댓글 신고 처리 완료 -->
  <update id="updateCommentReportProcess" parameterType="map">
    UPDATE COMMENT_REPORT
    SET PROCESS_YN = 'Y'
    WHERE REPORT_NO = #{reportNo}
  </update>


  <!-- ================= 신고 상세 조회 ================= -->
  <select id="selectReportDetail"
        parameterType="int"
        resultType="edu.kh.project.admin.dto.Report">

	SELECT
	    reportNo,
	    reportType,
	    targetNo,
	    reportReason,
	    reportDetail,
	    reportDate,
	    reportStatus,
	    reporterNickname,
	    boardNo,
	    targetTitle
	FROM (
	
	    /* 게시글 신고 */
	    SELECT
	        BR.REPORT_NO        AS reportNo,
	        'BOARD'             AS reportType,
	        BR.BOARD_NO         AS targetNo,
	        BR.REPORT_REASON    AS reportReason,
	        BR.REPORT_REASON_DETAIL   AS reportDetail,
	        BR.REPORT_DATE      AS reportDate,
	        BR.PROCESS_YN       AS reportStatus,
	        M.MEMBER_NICKNAME   AS reporterNickname,
	        B.BOARD_NO          AS boardNo,
	        B.BOARD_TITLE       AS targetTitle
	    FROM BOARD_REPORT BR
	    JOIN BOARD B ON BR.BOARD_NO = B.BOARD_NO
	    JOIN MEMBER M ON BR.MEMBER_NO = M.MEMBER_NO
	
	    UNION ALL
	
	    /* 댓글 신고 */
	    SELECT
	        CR.REPORT_NO        AS reportNo,
	        'COMMENT'           AS reportType,
	        CR.COMMENT_NO       AS targetNo,
	        CR.REPORT_REASON    AS reportReason,
	        NULL				AS reportDetail,
	        CR.REPORT_DATE      AS reportDate,
	        CR.PROCESS_YN       AS reportStatus,
	        M.MEMBER_NICKNAME   AS reporterNickname,
	        B.BOARD_NO          AS boardNo,
	        B.BOARD_TITLE       AS targetTitle
	    FROM COMMENT_REPORT CR
	    JOIN "COMMENT" C ON CR.COMMENT_NO = C.COMMENT_NO
	    JOIN BOARD B ON C.BOARD_NO = B.BOARD_NO
	    JOIN MEMBER M ON CR.MEMBER_NO = M.MEMBER_NO
	
	)
	WHERE reportNo = #{reportNo}
	
	</select>
  
  <!-- ================= 신고 대상 → 게시글 번호 ================= -->
	<select id="selectBoardNoByReportTarget" resultType="int">
	    SELECT BOARD_NO
	    FROM "COMMENT"
	    WHERE COMMENT_NO = #{targetNo}
	</select>

    <!-- ================= 게시글 상세 ================= -->
    <select id="selectBoardDetail" resultType="Board">
        SELECT
            BOARD_NO,
            BOARD_TITLE,
            BOARD_CONTENT,
            BOARD_CODE
        FROM BOARD
        WHERE BOARD_NO = #{boardNo}
    </select>

  <!-- ================= 댓글 목록 ================= -->
<select id="selectCommentListByBoardNo"
        parameterType="int"
        resultType="edu.kh.project.admin.dto.AdminReportComment">

    SELECT
        C.COMMENT_NO,
        C.COMMENT_CONTENT,
        C.MEMBER_NO,
        M.MEMBER_NICKNAME,
        M.PROFILE_IMG,
        C.COMMENT_WRITE_DATE,
        C.COMMENT_DEL_FL,
        C.PARENT_COMMENT_NO
    FROM "COMMENT" C
    JOIN MEMBER M
      ON C.MEMBER_NO = M.MEMBER_NO
    WHERE C.BOARD_NO = #{boardNo}
    ORDER BY
        NVL(C.PARENT_COMMENT_NO, C.COMMENT_NO),
        C.COMMENT_NO

</select>

  <!-- ================= 이전 신고글 ================= -->
<select id="selectPrevReportNo" resultType="int">
    SELECT MAX(REPORT_NO)
    FROM (
        SELECT REPORT_NO FROM BOARD_REPORT WHERE PROCESS_YN = 'N'
        UNION ALL
        SELECT REPORT_NO FROM COMMENT_REPORT WHERE PROCESS_YN = 'N'
    )
    WHERE REPORT_NO &lt; #{reportNo}
</select>

  <!-- ================= 다음 신고글 ================= -->
<select id="selectNextReportNo" resultType="int">
    SELECT MIN(REPORT_NO)
    FROM (
        SELECT REPORT_NO FROM BOARD_REPORT WHERE PROCESS_YN = 'N'
        UNION ALL
        SELECT REPORT_NO FROM COMMENT_REPORT WHERE PROCESS_YN = 'N'
    )
    WHERE REPORT_NO &gt; #{reportNo}
</select>

<!-- ================= 관리자 신고 상세용 댓글 목록 ================= -->
<select id="selectCommentListForReport"
        parameterType="int"
        resultType="edu.kh.project.admin.dto.AdminReportComment">

    SELECT
        C.COMMENT_NO,
        C.COMMENT_CONTENT,
        C.MEMBER_NO,
        M.MEMBER_NICKNAME,
        M.PROFILE_IMG,
        C.COMMENT_WRITE_DATE,
        C.COMMENT_DEL_FL,
        C.PARENT_COMMENT_NO
    FROM "COMMENT" C
    JOIN MEMBER M
      ON C.MEMBER_NO = M.MEMBER_NO
    WHERE C.BOARD_NO = #{boardNo}
    ORDER BY
        NVL(C.PARENT_COMMENT_NO, C.COMMENT_NO),
        C.COMMENT_NO

</select>

<!-- 이전/다음 신고글 제목 -->
<select id="selectReportTitle" resultType="string">
    SELECT B.BOARD_TITLE
    FROM BOARD_REPORT BR
    JOIN BOARD B ON BR.BOARD_NO = B.BOARD_NO
    WHERE BR.REPORT_NO = #{reportNo}

    UNION ALL

    SELECT B.BOARD_TITLE
    FROM COMMENT_REPORT CR
    JOIN "COMMENT" C ON CR.COMMENT_NO = C.COMMENT_NO
    JOIN BOARD B ON C.BOARD_NO = B.BOARD_NO
    WHERE CR.REPORT_NO = #{reportNo}
</select>

<!-- 게시글 신고 상세 -->
<select id="selectBoardReportDetail"
        parameterType="int"
        resultType="edu.kh.project.admin.dto.Report">

    SELECT
        BR.REPORT_NO AS reportNo,
        'BOARD' AS reportType,
        BR.BOARD_NO AS targetNo,
        BR.REPORT_REASON AS reportReason,
        BR.REPORT_REASON_DETAIL   AS reportDetail,
        BR.REPORT_DATE AS reportDate,
        BR.PROCESS_YN AS reportStatus,
        M.MEMBER_NICKNAME AS reporterNickname,
        B.BOARD_NO AS boardNo,
        B.BOARD_TITLE AS targetTitle
    FROM BOARD_REPORT BR
    JOIN BOARD B ON BR.BOARD_NO = B.BOARD_NO
    JOIN MEMBER M ON BR.MEMBER_NO = M.MEMBER_NO
    WHERE BR.REPORT_NO = #{reportNo}
      AND BR.PROCESS_YN = 'N'
</select>

<!-- 댓글 신고 상세 -->
<select id="selectCommentReportDetail"
        parameterType="int"
        resultType="edu.kh.project.admin.dto.Report">

    SELECT
        CR.REPORT_NO AS reportNo,
        'COMMENT' AS reportType,
        CR.COMMENT_NO AS targetNo,
        CR.REPORT_REASON AS reportReason,
        CR.REPORT_DATE AS reportDate,
        CR.PROCESS_YN AS reportStatus,
        M.MEMBER_NICKNAME AS reporterNickname,
        B.BOARD_NO AS boardNo,
        B.BOARD_TITLE AS targetTitle
    FROM COMMENT_REPORT CR
    JOIN "COMMENT" C ON CR.COMMENT_NO = C.COMMENT_NO
    JOIN BOARD B ON C.BOARD_NO = B.BOARD_NO
    JOIN MEMBER M ON CR.MEMBER_NO = M.MEMBER_NO
    WHERE CR.REPORT_NO = #{reportNo}
      AND CR.PROCESS_YN = 'N'
</select>



</mapper>
