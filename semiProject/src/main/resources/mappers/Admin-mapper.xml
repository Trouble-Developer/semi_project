<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.kh.project.admin.model.mapper.AdminMapper">

  <!-- 회원 수 조회 - 회원이 총 몇 명인지 알아야 페이지 수를 계산 가능 -->
  <select id="getMemberCount" resultType="int">
    SELECT COUNT(*)
    FROM MEMBER
    <where>
      <if test="key != null and query != null">
        <choose>
          <when test="'memberNo'.equals(key)">
            MEMBER_NO = #{query}
          </when>
          <when test="'email'.equals(key)">
            MEMBER_EMAIL LIKE '%' || #{query} || '%'
          </when>
          <when test="'nickname'.equals(key)">
            MEMBER_NICKNAME LIKE '%' || #{query} || '%'
          </when>
        </choose>
      </if>
    </where>
  </select>

  <!-- 회원 목록 조회 -->
  <select id="selectMemberList"
          resultType="edu.kh.project.admin.dto.AdminMember">
    SELECT
      MEMBER_NO AS memberNo,
      MEMBER_EMAIL AS memberEmail,
      MEMBER_NICKNAME AS memberNickname,
      MEMBER_DEL_FL AS memberDelFl,
      ENROLL_DATE AS enrollDate
    FROM MEMBER
    <where>
      <if test="key != null and query != null">
        <choose>
          <when test="'memberNo'.equals(key)">
            MEMBER_NO = #{query}
          </when>
          <when test="'email'.equals(key)">
            MEMBER_EMAIL LIKE '%' || #{query} || '%'
          </when>
          <when test="'nickname'.equals(key)">
            MEMBER_NICKNAME LIKE '%' || #{query} || '%'
          </when>
        </choose>
      </if>
    </where>
    ORDER BY MEMBER_NO DESC
    OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
  </select>

  <!-- 회원 상태 변경 (탈퇴 / 복구 공통) -->
  <update id="updateMemberStatus"
          parameterType="map">
    UPDATE MEMBER
    SET MEMBER_DEL_FL = #{memberDelFl}
    WHERE MEMBER_NO = #{memberNo}
  </update>
  
  
  <!-- 공지사항 -->
  <!-- 공지사항 전체 개수 조회 (검색 조건 포함) -->
  <select id="getNoticeCount"
          parameterType="map"
          resultType="int">

    SELECT COUNT(*)
    FROM BOARD B
    WHERE B.BOARD_DEL_FL = 'N'
      AND B.BOARD_CODE = 4

    <choose>
      <when test='key == "t"'>
        AND B.BOARD_TITLE LIKE '%' || #{query} || '%'
      </when>

      <when test='key == "c"'>
        AND B.BOARD_CONTENT LIKE '%' || #{query} || '%'
      </when>

      <when test='key == "tc"'>
        AND (
          B.BOARD_TITLE LIKE '%' || #{query} || '%'
          OR B.BOARD_CONTENT LIKE '%' || #{query} || '%'
        )
      </when>
    </choose>
  
  </select>
  
  <!-- 공지사항 목록 조회 -->
  <select id="selectNoticeList"
          parameterType="map"
          resultType="edu.kh.project.board.model.dto.Board">

    SELECT
      B.BOARD_NO         AS boardNo,
      B.BOARD_TITLE      AS boardTitle,
      M.MEMBER_NICKNAME  AS memberNickname,
      B.READ_COUNT       AS readCount,
      TO_CHAR(B.BOARD_WRITE_DATE, 'YYYY-MM-DD') AS boardWriteDate

    FROM BOARD B
    JOIN MEMBER M
      ON B.MEMBER_NO = M.MEMBER_NO

    WHERE B.BOARD_DEL_FL = 'N'
      AND B.BOARD_CODE = 4   <!-- 관리자 공지사항 고정 -->

    <choose>
      <!-- 제목 검색 -->
      <when test='key == "t"'>
        AND B.BOARD_TITLE LIKE '%' || #{query} || '%'
      </when>

      <!-- 내용 검색 -->
      <when test='key == "c"'>
        AND B.BOARD_CONTENT LIKE '%' || #{query} || '%'
      </when>

      <!-- 제목 + 내용 -->
      <when test='key == "tc"'>
        AND (
          B.BOARD_TITLE LIKE '%' || #{query} || '%'
          OR B.BOARD_CONTENT LIKE '%' || #{query} || '%'
        )
      </when>
    </choose>

    ORDER BY B.BOARD_NO DESC
    OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY

  </select>

  <!-- 공지사항 삭제 (관리자 전용 / 논리 삭제) -->
  <update id="deleteNotice" parameterType="int">
    UPDATE BOARD
    SET BOARD_DEL_FL = 'Y'
    WHERE BOARD_NO = #{boardNo}
  </update>


  <!-- 고객지원 게시글 -->
  <!-- 고객지원 게시글 전체 개수 조회 -->
  <!-- 페이징 계산을 위해 먼저 COUNT -->
  <select id="getSupportCount"
          parameterType="map"
          resultType="int">

    SELECT COUNT(*)
    FROM BOARD B
    WHERE B.BOARD_CODE = 3       <!-- 고객지원 게시판 코드 -->
      AND B.BOARD_DEL_FL = 'N'   <!-- 삭제되지 않은 글 -->

    <!-- 검색 조건이 있을 경우 -->
    <if test="key != null and query != null and query != ''">
      <choose>
        <when test="key == 'title'">
          AND B.BOARD_TITLE LIKE '%' || #{query} || '%'
        </when>
        <when test="key == 'content'">
          AND B.BOARD_CONTENT LIKE '%' || #{query} || '%'
        </when>
        <when test="key == 'writer'">
          AND B.MEMBER_NO IN (
            SELECT MEMBER_NO
            FROM MEMBER
            WHERE MEMBER_NICKNAME LIKE '%' || #{query} || '%'
          )
        </when>
      </choose>
    </if>

  </select>
  
  
  <!-- 고객지원 게시글 목록 조회 -->
  <select id="selectSupportList"
          parameterType="map"
          resultType="edu.kh.project.board.model.dto.Board">

    SELECT
      B.BOARD_NO         AS boardNo,
      B.BOARD_TITLE      AS boardTitle,
      M.MEMBER_NICKNAME  AS memberNickname,
      B.BOARD_WRITE_DATE AS boardWriteDate
    FROM BOARD B
    JOIN MEMBER M
      ON B.MEMBER_NO = M.MEMBER_NO
    WHERE B.BOARD_CODE = 3
      AND B.BOARD_DEL_FL = 'N'

    <!-- 검색 조건 -->
    <if test="key != null and query != null and query != ''">
      <choose>
        <when test="key == 'title'">
          AND B.BOARD_TITLE LIKE '%' || #{query} || '%'
        </when>
        <when test="key == 'content'">
          AND B.BOARD_CONTENT LIKE '%' || #{query} || '%'
        </when>
        <when test="key == 'writer'">
          AND M.MEMBER_NICKNAME LIKE '%' || #{query} || '%'
        </when>
      </choose>
    </if>

    <!-- 최신 글이 위로 오도록 정렬 -->
    ORDER BY B.BOARD_NO DESC

    <!-- 페이징 처리 -->
    OFFSET #{offset} ROWS
    FETCH NEXT #{limit} ROWS ONLY

  </select>
  




</mapper>
